"""Backend selection."""
import sys
import types

from celery._state import current_app
from celery.exceptions import ImproperlyConfigured, reraise
from celery.utils.imports import load_extension_class_names, symbol_by_name

__all__ = ('by_name', 'by_url')

UNKNOWN_BACKEND = """
Unknown result backend: {0!r}.  Did you spell that correctly? ({1!r})
"""

BACKEND_ALIASES = {
    'amqp': 'celeryapp.backends.amqp:AMQPBackend',
    'rpc': 'celeryapp.backends.rpc.RPCBackend',
    'cache': 'celeryapp.backends.cache:CacheBackend',
    'redis': 'celeryapp.backends.redis:RedisBackend',
    'rediss': 'celeryapp.backends.redis:RedisBackend',
    'sentinel': 'celeryapp.backends.redis:SentinelBackend',
    'mongodb': 'celeryapp.backends.mongodb:MongoBackend',
    'db': 'celeryapp.backends.database:DatabaseBackend',
    'database': 'celeryapp.backends.database:DatabaseBackend',
    'elasticsearch': 'celeryapp.backends.elasticsearch:ElasticsearchBackend',
    'cassandra': 'celeryapp.backends.cassandra:CassandraBackend',
    'couchbase': 'celeryapp.backends.couchbase:CouchbaseBackend',
    'couchdb': 'celeryapp.backends.couchdb:CouchBackend',
    'cosmosdbsql': 'celeryapp.backends.cosmosdbsql:CosmosDBSQLBackend',
    'riak': 'celeryapp.backends.riak:RiakBackend',
    'file': 'celeryapp.backends.filesystem:FilesystemBackend',
    'disabled': 'celeryapp.backends.base:DisabledBackend',
    'consul': 'celeryapp.backends.consul:ConsulBackend',
    'dynamodb': 'celeryapp.backends.dynamodb:DynamoDBBackend',
    'azureblockblob': 'celeryapp.backends.azureblockblob:AzureBlockBlobBackend',
    'arangodb': 'celeryapp.backends.arangodb:ArangoDbBackend',
    's3': 'celeryapp.backends.s3:S3Backend',
}


def by_name(backend=None, loader=None,
            extension_namespace='celeryapp.result_backends'):
    """Get backend class by name/alias."""
    backend = backend or 'disabled'
    loader = loader or current_app.loader
    aliases = dict(BACKEND_ALIASES, **loader.override_backends)
    aliases.update(
        load_extension_class_names(extension_namespace) or {})
    try:
        cls = symbol_by_name(backend, aliases)
    except ValueError as exc:
        reraise(ImproperlyConfigured, ImproperlyConfigured(
            UNKNOWN_BACKEND.strip().format(backend, exc)), sys.exc_info()[2])
    if isinstance(cls, types.ModuleType):
        raise ImproperlyConfigured(UNKNOWN_BACKEND.strip().format(
            backend, 'is a Python module, not a backend class.'))
    return cls


def by_url(backend=None, loader=None):
    """Get backend class by URL."""
    url = None
    if backend and '://' in backend:
        url = backend
        scheme, _, _ = url.partition('://')
        if '+' in scheme:
            backend, url = url.split('+', 1)
        else:
            backend = scheme
    return by_name(backend, loader), url
